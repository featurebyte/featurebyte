name: lint

on:
  workflow_dispatch:
  pull_request:
    types:
      [opened, synchronize, reopened]

env:
  # Python
  GCR_PYPI_PROJECT_ID: vpc-host-nonprod-xa739-xz970
  GCR_PYPI_REPO: featurebyte-pypi
  GCR_PYPI_LOCATION: us-central1
  POETRY_HTTP_BASIC_FEATUREBYTE_NP_USERNAME: _json_key_base64                           # Poetry to pull from google artifact factory [references pyproject.toml (tool.poetry.source).name]
  POETRY_HTTP_BASIC_FEATUREBYTE_NP_PASSWORD: ${{ secrets.GCR_PYPI_CREDENTIALS_RW_B64 }} # Poetry to pull from google artifact factory [references pyproject.toml (tool.poetry.source).name]

jobs:
  lint_flags:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    outputs:
      changes: ${{ steps.workflow_flags.outputs.CHANGES }}
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: '0'  # Used for checking diff

      - name: Workflow Flags
        id: workflow_flags
        run: echo "CHANGES=$(git diff origin/main..HEAD -- featurebyte/ tests/ pyproject.toml | wc -l) " >> $GITHUB_OUTPUT

  lint:
    needs: [lint_flags]
    if: ${{ needs.lint_flags.outputs.changes != 0 }}
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      matrix:
        python-version: ["3.8.0"]
    steps:
    - uses: actions/checkout@v3

    - name: Set up defaults
      run: |
        echo "REPOSITORY=$(grep -oP '/\K.+' <<< $GITHUB_REPOSITORY)" >> $GITHUB_ENV

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Setup cache
      uses: actions/cache@v3
      with:
        path: .venv
        key: poetry-cache-${{ runner.os }}-${{ matrix.python-version }}-${{ github.job }}

    - name: Install Poetry
      run: |
        python -m pip install --extra-index-url "https://_json_key_base64:${{ secrets.GCR_PYPI_CREDENTIALS_RW_B64 }}@${GCR_PYPI_LOCATION}-python.pkg.dev/${GCR_PYPI_PROJECT_ID}/${GCR_PYPI_REPO}/simple/" poetry==1.2.0rc99
        poetry config virtualenvs.in-project true

    - name: Install dependencies
      run: make install

    - name: Lint Checks
      run: make lint

    # IF its a MERGE to main branch
    #   Send message to developer channel
    # IF unable to find author email
    #   Send message to chester
    # ELSE
    #   Send message to commit author
    - name: Slack Message failure
      if: ${{ failure() }}
      run: |
        # Get Coverage data
        #   default to: N.A.
        export COVERAGE_PERCENTAGE=${{ steps.coverageComment.outputs.coverage }}
        export COVERAGE_PERCENTAGE=${COVERAGE_PERCENTAGE:-N.A.}

        # Get the last committed email address
        git fetch --no-recurse-submodules --prune origin ${GITHUB_HEAD_REF}
        export AUTHOR_EMAIL=$(git show -s --format='%ae' "origin/${GITHUB_HEAD_REF}")
        echo "AUTHOR_EMAIL=${AUTHOR_EMAIL}"

        if [ -z ${AUTHOR_EMAIL+x} ]; then
          export AUTHOR_ID=U03P1DE5R8V  # Send to `Chester`
        else
          # Lookup email address and export to AUTHOR_ID
          export AUTHOR_ID=`curl -X POST -H "Authorization: Bearer ${SLACK_OAUTH}" -H 'Content-type: application/json; charset=utf-8' https://slack.com/api/users.list | grep -oP $(echo '"id":"\K[^"]+?"(?:(?!"id").)*${AUTHOR_EMAIL}' | envsubst) | grep -oP '^[^"]+'`
        fi

        cat .github/slack-template-FAILED.json | envsubst | curl -X POST \
          -H "Authorization: Bearer ${SLACK_OAUTH}" \
          -H 'Content-type: application/json; charset=utf-8' \
          --data-binary @- https://slack.com/api/chat.postMessage
