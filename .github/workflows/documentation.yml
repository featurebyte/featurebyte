# This workflow will check to see what diffs will be made to the documentation. If there are any, this will fail
# the check. This is to ensure that all changes that are being made to documentation are signed off by a developer.
# To sign off, or skip the documentation check, add
#   - Add 'Documentation Changes Confirmed' label to the PR

name: documentation
on:
  pull_request:
    types: [opened, reopened, synchronize, labeled, unlabeled]
    branches:
      - main
env:
  GCR_PYPI_PROJECT_ID: vpc-host-nonprod-xa739-xz970
  GCR_PYPI_REPO: featurebyte-pypi
  GCR_PYPI_LOCATION: us-central1
  POETRY_HTTP_BASIC_FEATUREBYTE_NP_USERNAME: _json_key_base64 # Poetry to pull from google artifact factory [references pyproject.toml (tool.poetry.source).name]
  POETRY_HTTP_BASIC_FEATUREBYTE_NP_PASSWORD: ${{ secrets.GCR_PYPI_CREDENTIALS_R_B64 }} # Poetry to pull from google artifact factory [references pyproject.toml (tool.poetry.source).name]
concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref }}
  cancel-in-progress: true
jobs:
  check-should-run:
    runs-on: ubuntu-latest
#    if: ${{ !contains(github.event.pull_request.labels.*.name, 'Documentation Changes Confirmed') }}
#    steps:
#      - name: Exit
#        run: exit 0
#  build-updated-docs:
#    runs-on: ubuntu-20.04
#    strategy:
#      matrix:
#        python-version: [ "3.8.0" ]
#    needs: ["check-should-run"]
#    steps:
#      - uses: actions/checkout@v3
#        with:
#          fetch-depth: 0
#      - uses: arduino/setup-task@v1
#        with:
#          version: 3.x
#      - name: Set up Python ${{ matrix.python-version }}
#        uses: actions/setup-python@v4
#        with:
#          python-version: ${{ matrix.python-version }}
#      - name: Setup cache
#        uses: actions/cache@v3
#        with:
#          path: .venv
#          key: poetry-cache-${{ runner.os }}-${{ matrix.python-version }}-${{ github.job }}
#          restore-keys: poetry-cache-${{ runner.os }}-${{ matrix.python-version }} # Restore from `cache` job
#      - name: Install Poetry
#        uses: abatilo/actions-poetry@v2
#        with:
#          poetry-version: 1.3.1
#      - name: Configure Poetry
#        run: |
#          poetry config virtualenvs.in-project true
#          poetry config http-basic.featurebyte_np ${POETRY_HTTP_BASIC_FEATUREBYTE_NP_USERNAME} ${POETRY_HTTP_BASIC_FEATUREBYTE_NP_PASSWORD}
#      - name: Adding C headers
#        run: |
#          sudo apt-get install python-dev libsasl2-dev gcc
#          sudo apt-get install wkhtmltopdf
#      - name: Building docs for current branch
#        run: task docs-persist-reference
#      - name: Upload new docs
#        uses: actions/upload-artifact@v3
#        with:
#          name: docs-updated
#          path: site/reference/*
#  build-base-docs:
#    runs-on: ubuntu-20.04
#    strategy:
#      matrix:
#        python-version: [ "3.8.0" ]
#    needs: ["check-should-run"]
#    steps:
#      - uses: actions/checkout@v3
#        with:
#          fetch-depth: 0
#      - name: Checkout merge base
#        run: git checkout $(git merge-base "origin/${{ github.head_ref }}" origin/main)
#      - uses: arduino/setup-task@v1
#        with:
#          version: 3.x
#      - name: Set up Python ${{ matrix.python-version }}
#        uses: actions/setup-python@v4
#        with:
#          python-version: ${{ matrix.python-version }}
#      - name: Setup cache
#        uses: actions/cache@v3
#        with:
#          path: .venv
#          key: poetry-cache-${{ runner.os }}-${{ matrix.python-version }}-${{ github.job }}
#          restore-keys: poetry-cache-${{ runner.os }}-${{ matrix.python-version }} # Restore from `cache` job
#      - name: Install Poetry
#        uses: abatilo/actions-poetry@v2
#        with:
#          poetry-version: 1.3.1
#      - name: Configure Poetry
#        run: |
#          poetry config virtualenvs.in-project true
#          poetry config http-basic.featurebyte_np ${POETRY_HTTP_BASIC_FEATUREBYTE_NP_USERNAME} ${POETRY_HTTP_BASIC_FEATUREBYTE_NP_PASSWORD}
#      - name: Adding C headers
#        run: |
#          sudo apt-get install python-dev libsasl2-dev gcc
#          sudo apt-get install wkhtmltopdf
#      - name: Building docs for base branch
#        run: task docs-persist-reference
#      - name: Upload base docs
#        uses: actions/upload-artifact@v3
#        with:
#          name: docs-base
#          path: site/reference/*
#  diff-docs:
#    runs-on: ubuntu-latest
#    needs: ["build-updated-docs", "build-base-docs"]
#    steps:
#      - name: Download base docs
#        uses: actions/download-artifact@v3
#        with:
#          name: docs-base
#          path: featurebyte/docs/base/
#      - name: Download new docs
#        uses: actions/download-artifact@v3
#        with:
#          name: docs-updated
#          path: featurebyte/docs/updated/
    steps:
      - name: Install diff2html
        run: npm install -g diff2html-cli
      - name: Diff docs
        run: |
          mkdir -p featurebyte/docs/base
          mkdir -p featurebyte/docs/updated
          touch featurebyte/docs/base/a.txt
          echo "hello world" > featurebyte/docs/base/a.txt
          diff --new-file -ur featurebyte/docs/base/ featurebyte/docs/updated/ > diff.txt
      - name: Generate HTML
        run: |
          cat diff.txt | diff2html -i stdin --title="Documentation Differences" -F diff.html --style="side"
      - name: Upload diff html
        uses: actions/upload-artifact@v3
        with:
          name: docs-diff.html
          path: diff.html
      - name: Fail if diff is not empty
        run: |
          if [ -s diff.txt ]; then
            echo "Documentation changes detected. Please confirm that these changes are expected."
            exit 1
          fi
