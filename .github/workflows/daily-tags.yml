name: "Daily Tags Maintenance"

# Permission to push (DELETE) tags
permissions:
  contents: write

on:
  workflow_dispatch: {}
  schedule:
    - cron: '0 0 * * *'  # On 00:00 Everyday

jobs:
  # Delete remote tags that are older than a month old
  tags:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: '0'

      - name: "Setup Git"
        run: |
          git config --global user.name "featurebyte[bot]"
          git config --global user.email "featurebyte[bot]@users.noreply.github.com"

      - name: "Removing Tags"
        run: |
          export CUTOFF_DATE=$(date --date="-30days" +%Y-%m-%d)
          export EXPIRED_TAGS=$(git for-each-ref --format '%(creatordate:short) %(refname)' refs/tags | awk -v "CUTOFF_DATE=$CUTOFF_DATE" '{ if ($1 < CUTOFF_DATE) print $2; }')

          echo "### Expired tags" >> $GITHUB_STEP_SUMMARY
          printenv EXPIRED_TAGS >> $GITHUB_STEP_SUMMARY

          # => Convert ref/tags/ABC = :ref/tags/ABC
          # => git push origin :ref/tags/ABC
          printenv EXPIRED_TAGS | sed -nE 's/^/:/p' | xargs git push origin
