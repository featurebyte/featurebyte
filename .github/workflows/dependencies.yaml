# This workflow checks the differences dependencies between main and the PR
# Labelling a PR with `dependencies` will skip this check

name: dependencies
'on':
  pull_request:
    types:
      - opened
      - synchronize
      - reopened
      - labeled
      - unlabeled
    branches:
      - main
      - release/*
    paths:
      - pyproject.toml
      - uv.lock
permissions:
  contents: write
  pull-requests: write
  repository-projects: read
concurrency:
  group: "${{ github.workflow }}-${{ github.head_ref }}"
  cancel-in-progress: true
jobs:
  diff-client-deps:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version:
          - 3.10.14
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Checkout branch
        run: git checkout "origin/${{ github.head_ref }}"
      - name: Install uv and set the python version
        uses: astral-sh/setup-uv@v6
        with:
          python-version: ${{ matrix.python-version }}
          enable-cache: true
      - name: Build package (branch)
        run: |-
          uv sync --all-groups --all-extras --frozen
          uv pip list --exclude-editable > branch.PKG-INFO
      - name: Checkout merge base
        run: git checkout --force $(git merge-base "origin/${{ github.head_ref }}" origin/main)
      - name: Build package (main)
        run: |-
          uv sync --all-groups --all-extras --frozen
          uv pip list --exclude-editable > main.PKG-INFO
      - name: Diff dependencies
        continue-on-error: true
        run: |-
          # Write diff to env
          echo "DIFF<<EOF" >> $GITHUB_ENV
          set +e
          diff -u main.PKG-INFO branch.PKG-INFO >> $GITHUB_ENV
          set -e
          echo "EOF" >> $GITHUB_ENV

          # Test if it actually fails
          diff -u main.PKG-INFO branch.PKG-INFO
      - uses: mshick/add-pr-comment@v2
        with:
          message-id: dependencies
          message: |-
            **Dependency Changes**
            ```diff
            ${{ env.DIFF }}
            ```
      - name: Check failure if not labelled as dependencies
        if: ${{ !contains(github.event.pull_request.labels.*.name, 'dependencies') }}
        run: diff -u main.PKG-INFO branch.PKG-INFO

