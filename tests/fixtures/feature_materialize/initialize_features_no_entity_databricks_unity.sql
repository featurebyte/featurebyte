SELECT
  COUNT(*)
FROM `cat1__no_entity_1d`;

CREATE TABLE `sf_db`.`sf_schema`.`TEMP_REQUEST_TABLE_000000000000000000000000`
USING DELTA
TBLPROPERTIES (
  'delta.columnMapping.mode'='name',
  'delta.minReaderVersion'='2',
  'delta.minWriterVersion'='5'
) AS
SELECT
  1 AS `dummy_entity`;

CREATE OR REPLACE TABLE `sf_db`.`sf_schema`.`TEMP_REQUEST_TABLE_000000000000000000000000`
USING DELTA
TBLPROPERTIES (
  'delta.columnMapping.mode'='name',
  'delta.minReaderVersion'='2',
  'delta.minWriterVersion'='5'
) AS
SELECT
  ROW_NUMBER() OVER (ORDER BY 1) AS `__FB_TABLE_ROW_INDEX`,
  *
FROM `TEMP_REQUEST_TABLE_000000000000000000000000`;

CREATE TABLE `__TEMP_000000000000000000000000_0`
USING DELTA
TBLPROPERTIES (
  'delta.columnMapping.mode'='name',
  'delta.minReaderVersion'='2',
  'delta.minWriterVersion'='5'
) AS
WITH ONLINE_REQUEST_TABLE AS (
  SELECT
    REQ.`__FB_TABLE_ROW_INDEX`,
    CAST('2022-01-01 00:00:00' AS TIMESTAMP) AS POINT_IN_TIME
  FROM `sf_db`.`sf_schema`.`TEMP_REQUEST_TABLE_000000000000000000000000` AS REQ
), `REQUEST_TABLE_W86400_F86400_BS7200_M3600_` AS (
  SELECT
    `POINT_IN_TIME`,
    CAST(FLOOR((
      UNIX_TIMESTAMP(`POINT_IN_TIME`) - 3600
    ) / 86400) AS BIGINT) AS __FB_LAST_TILE_INDEX,
    CAST(FLOOR((
      UNIX_TIMESTAMP(`POINT_IN_TIME`) - 3600
    ) / 86400) AS BIGINT) - 1 AS __FB_FIRST_TILE_INDEX
  FROM (
    SELECT DISTINCT
      `POINT_IN_TIME`
    FROM ONLINE_REQUEST_TABLE
  )
), _FB_AGGREGATED AS (
  SELECT
    REQ.`__FB_TABLE_ROW_INDEX`,
    REQ.`POINT_IN_TIME`,
    `T0`.`_fb_internal_window_w86400_count_3178e5d8142ed182c5db45462cb780d18205bd64` AS `_fb_internal_window_w86400_count_3178e5d8142ed182c5db45462cb780d18205bd64`
  FROM ONLINE_REQUEST_TABLE AS REQ
  LEFT JOIN (
    SELECT
      `POINT_IN_TIME`,
      SUM(value_count_3178e5d8142ed182c5db45462cb780d18205bd64) AS `_fb_internal_window_w86400_count_3178e5d8142ed182c5db45462cb780d18205bd64`
    FROM (
      SELECT
        REQ.`POINT_IN_TIME`,
        TILE.INDEX,
        TILE.value_count_3178e5d8142ed182c5db45462cb780d18205bd64
      FROM `REQUEST_TABLE_W86400_F86400_BS7200_M3600_` AS REQ
      INNER JOIN __FB_DEPLOYED_TILE_TABLE_000000000000000000000000 AS TILE
        ON FLOOR(REQ.__FB_LAST_TILE_INDEX / 1) = FLOOR(TILE.INDEX / 1)
      WHERE
        TILE.INDEX >= REQ.__FB_FIRST_TILE_INDEX AND TILE.INDEX < REQ.__FB_LAST_TILE_INDEX
      UNION ALL
      SELECT
        REQ.`POINT_IN_TIME`,
        TILE.INDEX,
        TILE.value_count_3178e5d8142ed182c5db45462cb780d18205bd64
      FROM `REQUEST_TABLE_W86400_F86400_BS7200_M3600_` AS REQ
      INNER JOIN __FB_DEPLOYED_TILE_TABLE_000000000000000000000000 AS TILE
        ON FLOOR(REQ.__FB_LAST_TILE_INDEX / 1) - 1 = FLOOR(TILE.INDEX / 1)
      WHERE
        TILE.INDEX >= REQ.__FB_FIRST_TILE_INDEX AND TILE.INDEX < REQ.__FB_LAST_TILE_INDEX
    )
    GROUP BY
      `POINT_IN_TIME`
  ) AS T0
    ON REQ.`POINT_IN_TIME` = T0.`POINT_IN_TIME`
)
SELECT
  AGG.`__FB_TABLE_ROW_INDEX`,
  CAST(`_fb_internal_window_w86400_count_3178e5d8142ed182c5db45462cb780d18205bd64` AS BIGINT) AS `count_1d_V220101`
FROM _FB_AGGREGATED AS AGG;

CREATE TABLE `sf_db`.`sf_schema`.`TEMP_FEATURE_TABLE_000000000000000000000000`
USING DELTA
TBLPROPERTIES (
  'delta.columnMapping.mode'='name',
  'delta.minReaderVersion'='2',
  'delta.minWriterVersion'='5'
) AS
SELECT
  T0.`count_1d_V220101`,
  '0' AS `__featurebyte_dummy_entity`
FROM `TEMP_REQUEST_TABLE_000000000000000000000000` AS REQ
LEFT JOIN `__TEMP_000000000000000000000000_0` AS T0
  ON REQ.`__FB_TABLE_ROW_INDEX` = T0.`__FB_TABLE_ROW_INDEX`;

SELECT
  COUNT(*)
FROM `cat1__no_entity_1d`;

CREATE TABLE `sf_db`.`sf_schema`.`cat1__no_entity_1d`
USING DELTA
TBLPROPERTIES (
  'delta.columnMapping.mode'='name',
  'delta.minReaderVersion'='2',
  'delta.minWriterVersion'='5'
) AS
SELECT
  CAST('2022-01-01T00:00:00' AS TIMESTAMP) AS `__feature_timestamp`,
  `__featurebyte_dummy_entity`,
  `count_1d_V220101`
FROM `TEMP_FEATURE_TABLE_000000000000000000000000`;

ALTER TABLE `cat1__no_entity_1d` ALTER COLUMN `__feature_timestamp` SET NOT NULL;

ALTER TABLE `cat1__no_entity_1d` ALTER COLUMN `__featurebyte_dummy_entity` SET NOT NULL;

ALTER TABLE `cat1__no_entity_1d` ADD CONSTRAINT `pk_cat1__no_entity_1d`
PRIMARY KEY(`__feature_timestamp` TIMESERIES, `__featurebyte_dummy_entity`);
